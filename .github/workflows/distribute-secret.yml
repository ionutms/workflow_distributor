name: Distribute REPO_DISPATCH_TOKEN

on:
  workflow_dispatch:

env:
  TARGET_REPOS: >-
    ionutms/Minimal_AD74416H
    ionutms/Minimal_AD74416H_Stack_Adapter
    ionutms/AD74416H_Power_Interface_Module
    ionutms/Modular_AD74416H_PLC
    ionutms/Minimal_ADP1074
    ionutms/Minimal_ADPL76030
    ionutms/Minimal_ADP1032
    ionutms/Minimal_MAX14906
    ionutms/Minimal_AD74413R
    ionutms/Modular_Software_Configurable_IO_PLC
    ionutms/Minimal_ADIN1110
    ionutms/Minimal_LTC9111
    ionutms/Minimal_MAX17761
    ionutms/Minimal_LT8304
    ionutms/Minimal_MAX32650
    ionutms/Minimal_ADP1031
    ionutms/Minimal_MAX17570

jobs:
  distribute-secret:
    runs-on: ubuntu-latest
    steps:
      - name: Distribute secret to all target repositories
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_DISTRIBUTION_TOKEN }}
          SECRET_VALUE: ${{ secrets.REPO_DISPATCH_TOKEN }}
        run: |
          # Convert TARGET_REPOS to array
          REPOS=($TARGET_REPOS)
          
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Starting secret distribution to ${#REPOS[@]} repositories"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          
          # Process each repository
          for repo in "${REPOS[@]}"; do
            echo "→ Processing: $repo"
            
            if gh secret set REPO_DISPATCH_TOKEN \
              --repo "$repo" \
              --body "$SECRET_VALUE" 2>&1; then
              echo "  ✅ Successfully distributed to $repo"
              ((SUCCESS_COUNT++))
            else
              echo "  ❌ Failed to distribute to $repo"
              ((FAIL_COUNT++))
            fi
            echo ""
          done
          
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Distribution Summary:"
          echo "  ✅ Successful: $SUCCESS_COUNT"
          echo "  ❌ Failed: $FAIL_COUNT"
          echo "  📊 Total: ${#REPOS[@]}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          # Exit with error if any distribution failed
          if [ $FAIL_COUNT -gt 0 ]; then
            exit 1
          fi